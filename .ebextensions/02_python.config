# .ebextensions/python.config

# ==============================================================================
# 1) Standard EB Python platform settings
# ==============================================================================
option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: wsgi:application
    NumProcesses: 1
    NumThreads: 15

  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current:$PYTHONPATH"
    PORT: "8080"
    FLASK_APP: "main.py"


# ==============================================================================
# 2) Yum packages (including psmisc so that `fuser` exists, if you want to kill old pids)
# ==============================================================================
packages:
  yum:
    python3-devel: []
    gcc: []
    openssl-devel: []
    libffi-devel: []
    psmisc: []


# ==============================================================================
# 3) container_commands run after the application is staged
#    (We create log/pid dirs and safely kill any leftover Gunicorn/app processes)
# ==============================================================================
container_commands:

  # 3a) Create (and chown/chmod) a log directory for EncryptGate
  01_create_log_directory:
    command: |
      mkdir -p /var/log/encryptgate
      chmod -R 755 /var/log/encryptgate
      chown -R wsgi:wsgi /var/log/encryptgate || true
      chown -R webapp:webapp /var/log/encryptgate || true

  # 3b) Safely kill any leftover Gunicorn (or other) processes on port 8080.
  #      We wrap everything in a single bash -c, and end each kill with "|| true" so that
  #      even if the binary isn't present or no process is found, the command exits 0.
  02_cleanup_old_processes:
    command: |
      bash -c "pkill -9 -f gunicorn || true; fuser -k 8080/tcp || true"

  # 3c) Ensure the PID directory exists
  03_create_pid_directory:
    command: |
      mkdir -p /var/pids
      chmod 755 /var/pids
