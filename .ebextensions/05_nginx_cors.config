files:
  "/etc/nginx/conf.d/cors.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # CORS configuration for nginx
      map $http_origin $cors_origin {
          default "";
          "~^https://console-encryptgate\.net$" $http_origin;
          "~^https://.*\.console-encryptgate\.net$" $http_origin;
      }

      # Add CORS headers for all locations
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Access-Control-Max-Age' '86400' always;

      # Handle preflight OPTIONS requests
      if ($request_method = 'OPTIONS') {
          add_header 'Access-Control-Allow-Origin' $cors_origin always;
          add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
          add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With' always;
          add_header 'Access-Control-Allow-Credentials' 'true' always;
          add_header 'Access-Control-Max-Age' '86400' always;
          add_header 'Content-Type' 'text/plain; charset=utf-8';
          add_header 'Content-Length' '0';
          return 204;
      }
